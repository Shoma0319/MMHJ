#include<stdio.h>
#include<dirent.h>
#include<string.h>
#include<stdlib.h>

struct Document{
    int numberOfURL;
    char name[100];
    char link[10][100];
    double score;
};

int cmpfunc(const void *a, const void *b){
    if( (((struct Document*)a)->score < ((struct Document*)b)->score) ){
        return 1;
    } 
    else if( (((struct Document*)a)->score > ((struct Document*)b)->score) ){
        return -1;
    } else {
        return 0;
    }
}

int main(){
    DIR *folder;
    struct dirent *de;
    FILE *fp;
    char *base = "./source/";
    char fullFileName[100];
    int fileNamelength;
    char content[100];
    int fileCount=0;
    struct Document *documents;
    int i=0;
    int j=0;

    //calculate the number of files in teh source directory
    folder = opendir("./source");
    if(folder == NULL) {
        printf("Unable to read directory\n");
        return 1;
    } else {
        while((de = readdir(folder)) != NULL){
            if(de->d_type != 8) continue; //if de->d_type==8, it is file.
            fileCount++;
        }
    }
    closedir(folder);

    documents = (struct Document *)malloc(fileCount*sizeof(struct Document));

    //read the file contents
    folder = opendir("./source");

    if(folder == NULL) {
        printf("Unable to read directory\n");
        return 1;
    }
    else {
        while ((de = readdir(folder)) != NULL) {
            if(de->d_type != 8) continue;

            //initialize documents array
            strcpy(documents[i].name, de->d_name);
            documents[i].numberOfURL = 0;
            documents[i].score = 1;

            //create full file name(./source/___)
            fileNamelength = strlen(de->d_name)+1;
            strncpy(fullFileName, base, fileNamelength);
            fullFileName[fileNamelength] = '\0';
            strcat(fullFileName, de->d_name);

            fp = fopen(fullFileName, "r");
            while(1) {
                fscanf(fp, "%s", content);
                if(strstr(content, ".html") != NULL) { 
                    strcpy(documents[i].link[j], content);
                    documents[i].numberOfURL += 1;
                    j++;
                }
                if( feof(fp) ) break;
            }
            fclose(fp);
            i++;
            j = 0;
        }
    }
    closedir(folder);

    //calculate the scores of each file
    for(int i=0; i<20; i++){ //20 times
        for(int j=0; j<fileCount; j++){ //page t
            documents[j].score = 0.15;
            for(int k=0; k<fileCount; k++){ //page s
                for(int l=0; l<documents[k].numberOfURL; l++){  //page s's link
                    if(strcmp(documents[k].link[l], documents[j].name)==0){
                        documents[j].score += 0.85 * (documents[k].score / documents[k].numberOfURL);
                    }
                }
            }
        }
    }

    qsort(documents, fileCount, sizeof(struct Document), cmpfunc);

    for(int i=0; i<fileCount; i++){
        printf("%s %lf\n", documents[i].name, documents[i].score);
    }

    return 0;
}
